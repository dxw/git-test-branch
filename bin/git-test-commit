#!/bin/sh
set -e

COMMIT=${1}
COMMAND=${2}

if test "${COMMIT}" = ""; then
  echo "Usage: git test-commit @ 'command-to-run'"
  exit 1
fi

if test "${COMMAND}" = ""; then
  echo "Usage: git test-commit @ 'command-to-run'"
  exit 1
fi

run_exclusively() {
  flock "$(git rev-parse --show-toplevel)/.git-test-commit/lock" "${@}"
}

note() {
  run_exclusively git notes --ref=refs/notes/dxw-git-test-commit add --force --message="${1}" "${COMMIT}"
}

if git notes --ref=refs/notes/dxw-git-test-commit show "${COMMIT}" 2>/dev/null; then
  echo "There's already a test result for this commit. Will not re-run."
  exit
fi

note RUNNING

echo "${COMMIT} ${COMMAND}"
DIR=$(git rev-parse --show-toplevel)/.git-test-commit/${COMMIT}

rm -rf "${DIR}"
run_exclusively git worktree add --force --detach "${DIR}" "${COMMIT}"

if sh -c "cd ${DIR} && ${COMMAND}"; then
  note PASS
else
  note FAIL
fi

git worktree remove "${DIR}"
