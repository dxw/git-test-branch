#!/bin/sh
set -e

COMMIT=${1}
COMMAND=${2}

if test "${COMMIT}" = ""; then
  echo "Usage: git test-commit @ 'command-to-run'"
  exit 1
fi

if test "${COMMAND}" = ""; then
  echo "Usage: git test-commit @ 'command-to-run'"
  exit 1
fi

ROOT="$(git rev-parse --show-toplevel)/.git-test-commit"

run_exclusively() {
  flock "${ROOT}/lock" "${@}"
}

note() {
  run_exclusively git notes --ref=refs/notes/dxw-git-test-commit add --force --message="${1}" "${COMMIT}"
}

note RUNNING

echo "${COMMIT} ${COMMAND}"
DIR="${ROOT}/${COMMIT}"

rm -rf "${DIR}"
run_exclusively git worktree add --force --detach "${DIR}" "${COMMIT}"

if sh -c "cd ${DIR} && ${COMMAND}"; then
  note PASS
else
  note FAIL
fi

git worktree remove "${DIR}"
